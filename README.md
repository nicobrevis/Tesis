OpenTPS DDM Exporter & ProcessorEste repositorio contiene herramientas y gu√≠as para extraer, filtrar y procesar la Matriz de Deposici√≥n de Dosis (DDM) desde el software de planificaci√≥n de radioterapia OpenTPS.El objetivo principal es habilitar la Optimizaci√≥n Robusta externa permitiendo el acceso a la matriz de influencia $D$, la cual no es exportable nativamente desde la interfaz gr√°fica de OpenTPS.üìã Caracter√≠sticasExtracci√≥n Autom√°tica: Modificaci√≥n del c√≥digo fuente de OpenTPS para interceptar la DDM desde la memoria RAM.Filtrado Espacial (ROI): Script para reducir la dimensionalidad de la matriz, conservando solo los v√≥xeles correspondientes a una Regi√≥n de Inter√©s (ej. GTV-1, Tumor), reduciendo el tama√±o de datos en un ~99%.Manejo de Escenarios Robustos: Detecci√≥n autom√°tica y extracci√≥n del escenario nominal en simulaciones que incluyen incertidumbre.Conversi√≥n a Formatos Est√°ndar: Exportaci√≥n a .txt y .npz separando por √°ngulos de incidencia (Haces/Beams).‚öôÔ∏è RequisitosPython 3.8+Entorno virtual con OpenTPS instalado.Librer√≠as adicionales: numpy, scipy, pandas.üöÄ Paso 1: Modificaci√≥n del C√≥digo Fuente (El "Hack")Para poder extraer la matriz, es necesario inyectar un peque√±o bloque de c√≥digo en el motor de c√°lculo de OpenTPS.Localiza el archivo mcsquareDoseCalculator.py. Usualmente se encuentra en:.../site-packages/opentps/core/processing/doseCalculation/mcsquareDoseCalculator.pyBusca la funci√≥n computeBeamlets.Al final de la funci√≥n, justo antes del return beamletDose, inserta el siguiente c√≥digo:Python    # --- INICIO MODIFICACI√ìN: EXTRACCI√ìN DDM ---
    try:
        from opentps.core.io.serializedObjectIO import saveBeamlets
        import logging
        logger = logging.getLogger(__name__)
        
        # Ruta donde quieres que aparezca el archivo. CAMBIA ESTA RUTA.
        ruta_guardado = 'C:/Script/ddm_exportada_auto.blm' 
        
        saveBeamlets(beamletDose, ruta_guardado)
        logger.info(f"DDM interceptada y guardada en: {ruta_guardado}")
    except Exception as e:
        logger.error(f"Error exportando DDM: {e}")
    # --- FIN MODIFICACI√ìN ---

    return beamletDose # Esta l√≠nea ya existe, no la borres.
üõ†Ô∏è Paso 2: Generaci√≥n de la MatrizAbre OpenTPS.Carga tu paciente (CT) y configura tu Plan de Tratamiento (Haces, √°ngulos, etc.).Haz clic en "Compute Dose".Al finalizar, aparecer√° autom√°ticamente el archivo ddm_exportada_auto.blm en la carpeta que configuraste.üíª Paso 3: Filtrado y Conversi√≥n (Scripts)Este repositorio incluye dos scripts principales para procesar el archivo .blm crudo.1. Extracci√≥n y Filtrado (extract_roi.py)Este script carga la DDM completa y la imagen CT. Utiliza los contornos DICOM para crear una m√°scara binaria y extraer solo las filas correspondientes al tumor (GTV), reduciendo dr√°sticamente el tama√±o del archivo.Caracter√≠sticas:Alinea la geometr√≠a CT con la DDM.Detecta si la DDM contiene escenarios de robustez apilados y extrae solo el escenario nominal.2. Conversi√≥n a Texto por √Ångulos (convert_to_txt.py)Convierte el archivo .npz filtrado a archivos de texto plano (.txt) separando los beamlets por √°ngulo de disparo, listo para ser usado en optimizadores como CVXPY o MATLAB.Configuraci√≥n Importante:Debes editar la variable limite_beam_1 con el n√∫mero de Scanning Spots del primer haz (dato visible en la pesta√±a "Plan Design" de OpenTPS).Python# Ejemplo
limite_beam_1 = 4250 # Poner aqu√≠ el n√∫mero de spots del Beam 1
üì¶ Estructura de Datos ResultanteEl flujo de trabajo genera los siguientes archivos:ArchivoDescripci√≥nFormatoddm_exportada_auto.blmMatriz cruda completa (Todo el cuerpo).Binario OpenTPSddm_GTV-1.npzMatriz dispersa filtrada (Solo Tumor).Python Sparseddm_GTV-1_Angulo1.txtDatos del Haz 1 (columnas: voxel, beamlet, intensidad).CSV/TXTddm_GTV-1_Angulo2.txtDatos del Haz 2.CSV/TXT‚ö†Ô∏è Soluci√≥n de Problemas ComunesError: "Dimensions mismatch / La m√°scara no coincide"Si el script dice que la DDM es 2 veces m√°s grande que la m√°scara, significa que OpenTPS calcul√≥ escenarios de incertidumbre. El script extract_roi.py incluido en este repo soluciona esto autom√°ticamente cortando la matriz para obtener el escenario nominal.
